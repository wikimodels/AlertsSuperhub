<main>
  <h1>üìà KlineDataService Test App (v2)</h1>
  <p>
    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ "–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞" (KlineDataService) —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ IndexedDB.
  </p>

  <div class="actions">
    <button (click)="loadKlines('1h')" [disabled]="isLoading()">
      –ó–∞–≥—Ä—É–∑–∏—Ç—å 1h
    </button>
    <button (click)="loadKlines('4h')" [disabled]="isLoading()">
      –ó–∞–≥—Ä—É–∑–∏—Ç—å 4h
    </button>
    <button (click)="loadKlines('12h')" [disabled]="isLoading()">
      –ó–∞–≥—Ä—É–∑–∏—Ç—å 12h
    </button>
    <button (click)="loadKlines('D')" [disabled]="isLoading()">
      –ó–∞–≥—Ä—É–∑–∏—Ç—å D
    </button>
    <button (click)="loadAllKlines()" [disabled]="isLoading()">
      –ó–∞–≥—Ä—É–∑–∏—Ç—å –í–°–ï
    </button>
  </div>

  <div class="actions-secondary">
    <button (click)="clearCache()" [disabled]="isLoading()" class="button-danger">
      –û—á–∏—Å—Ç–∏—Ç—å –ö–µ—à (IndexedDB)
    </button>
  </div>


  <!-- ‚úÖ –ê–Ω–∏–º–∞—Ü–∏—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ [@fadeSpinner] -->
  @if (isLoading()) {
  <div class="loading-overlay" [@fadeSpinner]>
    <app-loading-spinner></app-loading-spinner>
  </div>
  }

  <!-- === –í–´–í–û–î –î–õ–Ø –û–î–ù–û–ì–û –¢–ê–ô–ú–§–†–ï–ô–ú–ê === -->
  <!-- ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï:
    –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –ò –∑–∞–≥—Ä—É–∑–∫–∞ –ù–ï –∏–¥–µ—Ç.
    –≠—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç :leave, –∫–æ–≥–¥–∞ isLoading() —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è true.
  -->
  @if (marketData(); as data) {
  @if (!isLoading()) {

  <!-- ‚úÖ –ê–Ω–∏–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö [@fadeData] -->
  <div class="card" [@fadeData]>
    <h2>
      ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã: {{ data.timeframe | uppercase }}
    </h2>
    <div class="card-content">
      <p>
        <strong>–í—Ä–µ–º—è —Å–Ω—ç–ø—à–æ—Ç–∞:</strong>
        <span>{{ data.updatedAt | formatTimestamp }}</span>
      </p>
      <p>
        <strong>–í—Ä–µ–º—è —Å–≤–µ—á–∏:</strong>
        <span>{{ data.openTime | formatTimestamp }}</span>
      </p>
      <p>
        <strong>–ö–æ–ª-–≤–æ –º–æ–Ω–µ—Ç:</strong> <span>{{ data.coinsNumber }}</span>
      </p>
    </div>
  </div>

  @if (getLastCandle(getFirstCoin(data)); as lastCandle) {

  <!-- ‚úÖ –ê–Ω–∏–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö [@fadeData] -->
  <div class="card" [@fadeData]>
    <h2>
      üïØÔ∏è –í—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–≤–µ—á–∏ (–ú–æ–Ω–µ—Ç–∞:
      {{ getFirstCoin(data)?.symbol }})
    </h2>
    <table>
      <thead>
        <tr>
          <th>–°–≤–æ–π—Å—Ç–≤–æ</th>
          <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
        </tr>
      </thead>
      <tbody>
        @for (key of objectKeys(lastCandle); track key) {
        <tr>
          <td><strong>{{ key }}</strong></td>
          <td>
            @if (key === 'openTime' || key === 'closeTime') {
            <span>{{ getCandleValue(lastCandle, key) | formatTimestamp }}</span>
            } @else if (isNumber(getCandleValue(lastCandle, key))) {
            <span>{{ getCandleValue(lastCandle, key) | formatNumber }}</span>
            } @else {
            <span>{{ getCandleValue(lastCandle, key) }}</span>
            }
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }

  @if (getFirstCoin(data); as firstCoin) {

  <!-- ‚úÖ –ê–Ω–∏–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö [@fadeData] -->
  <div class="card" [@fadeData]>
    <h2>üïØÔ∏è –í—Å–µ 400 —Å–≤–µ—á–µ–π (–ú–æ–Ω–µ—Ç–∞: {{ firstCoin.symbol }})</h2>
    <div class="full-candle-table-wrapper">
      <table class="full-candle-table">
        <!-- (–ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã...) -->
        <thead>
          <tr>
            <th>–í—Ä–µ–º—è</th>
            <th>–¶–µ–Ω–∞ –ó–∞–∫—Ä.</th>
            <th>EMA 50</th>
            <th>KAMA</th>
            <th>RSI</th>
            <th>ADX</th>
            <th>MACD</th>
            <th>Signal</th>
            <th>Hist</th>
            <th>CMF</th>
            <th>CHV</th>
            <th>OBV</th>
            <th>BB Basis</th>
            <th>W-AVWAP</th>
            <th>RVWAP</th>
            <!-- –ü–∞—Ç—Ç–µ—Ä–Ω—ã -->
            <th>Doji</th>
            <th>Hammer</th>
            <th>Bullish Engulfing</th>
            <th>Bearish Engulfing</th>
            <th>Pinbar</th>
            <!-- Highest/Lowest -->
            <th>Lowest 50</th>
            <th>Lowest 100</th>
            <th>Highest 50</th>
            <th>Highest 100</th>
            <!-- VZO -->
            <th>VZO</th>
            <!-- Z-Score -->
            <th>Z-Score Close</th>
            <th>Z-Score Volume</th>
            <th>Z-Score VolDelta</th>
            <th>Z-Score OI</th>
            <th>Z-Score Funding</th>
            <!-- Slope -->
            <th>Slope EMA 50</th>
            <th>Slope EMA 100</th>
            <th>Slope EMA 150</th>
            <th>Slope RVWAP</th>
            <th>Slope M-AVWAP</th>
            <th>Slope W-AVWAP</th>
            <th>Slope Z Close</th>
            <th>Slope Z Vol</th>
            <th>Slope Z VolDelta</th>
            <th>Slope Z OI</th>
            <th>Slope Z Funding</th>
            <!-- STATES: EMA 50 -->
            <th>‚Üë EMA50</th>
            <th>‚Üì EMA50</th>
            <th>‚Üó EMA50</th>
            <th>‚Üò EMA50</th>
            <!-- STATES: EMA 100 -->
            <th>‚Üë EMA100</th>
            <th>‚Üì EMA100</th>
            <th>‚Üó EMA100</th>
            <th>‚Üò EMA100</th>
            <!-- STATES: EMA 150 -->
            <th>‚Üë EMA150</th>
            <th>‚Üì EMA150</th>
            <th>‚Üó EMA150</th>
            <th>‚Üò EMA150</th>
            <!-- STATES: KAMA -->
            <th>‚Üë KAMA</th>
            <th>‚Üì KAMA</th>
            <th>‚Üó KAMA</th>
            <th>‚Üò KAMA</th>
            <!-- STATES: RVWAP -->
            <th>‚Üë RVWAP</th>
            <th>‚Üì RVWAP</th>
            <th>‚Üó RVWAP</th>
            <th>‚Üò RVWAP</th>
            <th>‚Üî RVWAP Band</th>
            <!-- STATES: W-AVWAP -->
            <th>‚Üë W-AVWAP</th>
            <th>‚Üì W-AVWAP</th>
            <th>‚Üó W-AVWAP</th>
            <th>‚Üò W-AVWAP</th>
            <!-- STATES: M-AVWAP -->
            <th>‚Üë M-AVWAP</th>
            <th>‚Üì M-AVWAP</th>
            <th>‚Üó M-AVWAP</th>
            <th>‚Üò M-AVWAP</th>
            <!-- EMA FAN -->
            <th>Bullish Fan</th>
            <th>Bearish Fan</th>
            <th>Mess Fan</th>
            <th>Bull Punch</th>
            <th>Bear Punch</th>
            <!-- BREAKOUTS -->
            <th>‚Üó HH50</th>
            <th>‚Üò LL50</th>
            <th>‚Üó HH100</th>
            <th>‚Üò LL100</th>
          </tr>
        </thead>
        <!-- (–¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã...) -->
        <tbody>
          @for (candle of firstCoin.candles; track candle.openTime) {
          <tr>
            <td>{{ candle.openTime | formatTimestamp }}</td>
            <td>{{ candle.closePrice | formatNumber }}</td>
            <td>{{ candle.ema50 | formatNumber }}</td>
            <td>{{ candle.kama | formatNumber }}</td>
            <td>{{ candle.rsi | formatNumber }}</td>
            <td>{{ candle.adx | formatNumber }}</td>
            <td>{{ candle.macd | formatNumber }}</td>
            <td>{{ candle.macdSignal | formatNumber }}</td>
            <td>{{ candle.macdHistogram | formatNumber }}</td>
            <td>{{ candle.cmf | formatNumber }}</td>
            <td>{{ candle.chv | formatNumber }}</td>
            <td>{{ candle.obv | formatNumber }}</td>
            <td>{{ candle.bbBasis | formatNumber }}</td>
            <td>{{ candle.wAvwap | formatNumber }}</td>
            <td>{{ candle.rvwap | formatNumber }}</td>
            <!-- Patterns -->
            <td>{{ candle.isDoji }}</td>
            <td>{{ candle.isHammer }}</td>
            <td>{{ candle.isBullishEngulfing }}</td>
            <td>{{ candle.isBearishEngulfing }}</td>
            <td>{{ candle.isPinbar }}</td>
            <!-- Highest/Lowest -->
            <td>{{ candle.lowest50 | formatNumber }}</td>
            <td>{{ candle.lowest100 | formatNumber }}</td>
            <td>{{ candle.highest50 | formatNumber }}</td>
            <td>{{ candle.highest100 | formatNumber }}</td>
            <!-- VZO -->
            <td>{{ candle.vzo | formatNumber }}</td>
            <!-- Z-Score -->
            <td>{{ candle.closePriceZScore | formatNumber }}</td>
            <td>{{ candle.volumeZScore | formatNumber }}</td>
            <td>{{ candle.volumeDeltaZScore | formatNumber }}</td>
            <td>{{ candle.openInterestZScore | formatNumber }}</td>
            <td>{{ candle.fundingRateZScore | formatNumber }}</td>
            <!-- Slope -->
            <td>{{ candle.slopeEma50 | formatNumber }}</td>
            <td>{{ candle.slopeEma100 | formatNumber }}</td>
            <td>{{ candle.slopeEma150 | formatNumber }}</td>
            <td>{{ candle.slopeRvwap | formatNumber }}</td>
            <td>{{ candle.slopeMAvwap | formatNumber }}</td>
            <td>{{ candle.slopeWAvwap | formatNumber }}</td>
            <td>{{ candle.slopeZClose | formatNumber }}</td>
            <td>{{ candle.slopeZVolume | formatNumber }}</td>
            <td>{{ candle.slopeZVolumeDelta | formatNumber }}</td>
            <td>{{ candle.slopeZOi | formatNumber }}</td>
            <td>{{ candle.slopeZFunding | formatNumber }}</td>
            <!-- STATES: EMA 50 -->
            <td>{{ candle.isAboveEma50 }}</td>
            <td>{{ candle.isBelowEma50 }}</td>
            <td>{{ candle.isCrossedUpEma50 }}</td>
            <td>{{ candle.isCrossedDownEma50 }}</td>
            <!-- STATES: EMA 100 -->
            <td>{{ candle.isAboveEma100 }}</td>
            <td>{{ candle.isBelowEma100 }}</td>
            <td>{{ candle.isCrossedUpEma100 }}</td>
            <td>{{ candle.isCrossedDownEma100 }}</td>
            <!-- STATES: EMA 150 -->
            <td>{{ candle.isAboveEma150 }}</td>
            <td>{{ candle.isBelowEma150 }}</td>
            <td>{{ candle.isCrossedUpEma150 }}</td>
            <td>{{ candle.isCrossedDownEma150 }}</td>
            <!-- STATES: KAMA -->
            <td>{{ candle.isAboveKama }}</td>
            <td>{{ candle.isBelowKama }}</td>
            <td>{{ candle.isCrossedUpKama }}</td>
            <td>{{ candle.isCrossedDownKama }}</td>
            <!-- STATES: RVWAP -->
            <td>{{ candle.isAboveRvwap }}</td>
            <td>{{ candle.isBelowRvwap }}</td>
            <td>{{ candle.isCrossedUpRvwap }}</td>
            <td>{{ candle.isCrossedDownRvwap }}</td>
            <td>{{ candle.isBetweenRvwapBands }}</td>
            <!-- STATES: W-AVWAP -->
            <td>{{ candle.isAboveWAvwap }}</td>
            <td>{{ candle.isBelowWAvwap }}</td>
            <td>{{ candle.isCrossedUpWAvwap }}</td>
            <td>{{ candle.isCrossedDownWAvwap }}</td>
            <!-- STATES: M-AVWAP -->
            <td>{{ candle.isAboveMAvwap }}</td>
            <td>{{ candle.isBelowMAvwap }}</td>
            <td>{{ candle.isCrossedUpMAvwap }}</td>
            <td>{{ candle.isCrossedDownMAvwap }}</td>
            <!-- EMA FAN -->
            <td>{{ candle.isBullishFan }}</td>
            <td>{{ candle.isBearishFan }}</td>
            <td>{{ candle.isMessFan }}</td>
            <td>{{ candle.isBullishPunch }}</td>
            <td>{{ candle.isBearishPunch }}</td>
            <!-- BREAKOUTS -->
            <td>{{ candle.isCrossedUpHighest50 }}</td>
            <td>{{ candle.isCrossedDownLowest50 }}</td>
            <td>{{ candle.isCrossedUpHighest100 }}</td>
            <td>{{ candle.isCrossedDownLowest100 }}</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
  }
  }
  }

  <!-- === –í–´–í–û–î –î–õ–Ø "–í–°–ï–•" –¢–ê–ô–ú–§–†–ï–ô–ú–û–í === -->
  <!-- ‚úÖ –ò–ó–ú–ï–ù–ï–ù–ò–ï:
    –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –ò –∑–∞–≥—Ä—É–∑–∫–∞ –ù–ï –∏–¥–µ—Ç.
  -->
  @if (allMarketData(); as allData) {
  @if (!isLoading()) {

  <!-- ‚úÖ –ê–Ω–∏–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö [@fadeData] -->
  <div class="card" [@fadeData]>
    <h2>‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã: –í–°–ï –¢–∞–π–º—Ñ—Ä–µ–π–º—ã</h2>
    <div class="card-content">
      <p>–°–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º —Å–Ω—ç–ø—à–æ—Ç–∞–º (–æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–æ):</p>
      <ul>
        @for (item of allData; track item.timeframe) {
        <li>
          <strong>{{ item.timeframe | uppercase }}:</strong>
          {{ item.coinsNumber }} –º–æ–Ω–µ—Ç,
          –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ item.updatedAt | formatTimestamp }}
        </li>
        }
      </ul>
    </div>
  </div>
  }
  }
</main>
